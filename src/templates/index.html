<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>cairnslab</title>

    <!-- Blockly package instalation: -->
    <!-- To Do: Better to use npm package, currently use cdn -->
    <!--
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>
    -->
    <script src="https://cdn.jsdelivr.net/npm/blockly@10.1.2/blockly_compressed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blockly@10.1.2/blocks_compressed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blockly@10.1.2/javascript_compressed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blockly@10.1.2/python_compressed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blockly@10.1.2/msg/en.js"></script>
    <!-- io/socket package instalation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Original block instalation -->
    <script src="/static/piblock.js"></script>
    <script src="/static/piblock_block.js"> </script>

    <!-- Toolbox and Start Block instalation for Blockly Workspace -->
    <script src="/static/toolbox.js"></script>
    <script src="/static/startblocks.js"></script>

    <!-- Define css style sheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Refer to Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>

      :root{
        --bg: #f5f7fa;
        --panel: rgba(255,255,255,0.75);
        --muted: #8a8f98;
        --accent: #0a84ff; /* Apple風アクセント */
        --glass-blur: 10px;
        --card-radius: 12px;
        --space: 18px;
        --shadow-1: 0 6px 18px rgba(20,24,30,0.06);
        --shadow-2: 0 10px 30px rgba(20,24,30,0.08);
        font-synthesis: none;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background: linear-gradient(180deg, var(--bg), #eef2f6);
        font-family: Inter, -apple-system, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color:#111827;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
        padding:24px;
      }

      /* ページレイアウト */
      .app {
        display:flex;
        gap:28px;
        align-items:stretch;
        height:calc(100vh - 48px);
      }

      /* 左サイド */
      .left {
        width:420px;
        min-width:320px;
        display:flex;
        flex-direction:column;
        gap:20px;
      }

      /* 左上カード（操作群） */
      .card {
        background: var(--panel);
        backdrop-filter: blur(var(--glass-blur));
        border-radius: var(--card-radius);
        padding:18px;
        box-shadow: var(--shadow-1);
        border: 1px solid rgba(255,255,255,0.6);
      }

      /* ヘッダ */
      .header {
        display:flex;
        align-items:center;
        gap:12px;
      }
      .logo {
        width:44px;
        height:44px;
        border-radius:10px;
        background: linear-gradient(135deg, rgba(255,255,255,0.6), rgba(250,250,250,0.35));
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
        color:var(--accent);
        box-shadow: var(--shadow-1);
        border:1px solid rgba(255,255,255,0.5);
        font-size:18px;
      }
      .title {
        font-size:18px;
        font-weight:600;
        letter-spacing:0.1px;
      }
      .subtitle {
        font-size:13px;
        color:var(--muted);
        margin-top:3px;
      }

      /* ボタン群 */
      .btn-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
      .button {
        padding:10px 14px;
        border-radius:10px;
        background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.85));
        border: 1px solid rgba(16,24,40,0.06);
        box-shadow: 0 2px 8px rgba(16,24,40,0.04);
        font-size:14px;
        cursor:pointer;
        transition: transform .12s ease, box-shadow .12s;
      }
      /* カーソルを重ねた時の反応 */
      .button:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
      }

      /* クリック時の反応（押し込まれる感） */
      .button:active {
        transform: translateY(0);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
      }
      .button.secondary {
        background: transparent;
        border: 1px solid rgba(16,24,40,0.06);
        color:#111827;
      }
      .button.ghost {
        background: transparent;
        border: 1px dashed rgba(16,24,40,0.06);
      }

      /* コントロールのグループ見出し */
      .group-title {
        font-size:13px;
        color:var(--muted);
        margin-top:8px;
        margin-bottom:8px;
        font-weight:600;
        letter-spacing:0.6px;
      }

      /* 小さい説明 */
      .hint {
        font-size:12px;
        color:var(--muted);
      }

      /* コンソールカード */
      .console {
        flex:1;
        display:flex;
        flex-direction:column;
        gap:12px;
        overflow:hidden;
      }
      .console .term {
        background: #0f1720;
        color: #9ef08f;
        border-radius:10px;
        padding:16px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
        font-size:13px;
        height:320px;
        overflow:auto;
        box-shadow: var(--shadow-2);
        border: 1px solid rgba(255,255,255,0.02);
      }

      /* 右エリア - Blockly を置く領域 */
      .right {
        flex:1;
        min-width:520px;
        background: #ffffff;
        border-radius:14px;
        box-shadow: var(--shadow-2);
        padding:22px;
        display:flex;
        flex-direction:column;
        overflow:hidden;
        border: 1px solid rgba(16,24,40,0.04);
      }

      /* Blocklyヘッダ */
      .blockly-top {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:12px;
      }
      .blockly-title {
        font-weight:600;
        font-size:15px;
        color:#111827;
      }
      .blockly-area {
        flex:1;
        border-radius:10px;
        background: linear-gradient(180deg, #fff, #fbfdff);
        border: 1px solid rgba(16,24,40,0.02);
        overflow:hidden;
        position:relative;
      }

      /* 小さいレスポンシブ調整 */
      @media (max-width:980px){
        .app { flex-direction:column; padding:16px; height:auto }
        .left { width:100% }
        .right { min-width:unset; width:100% }
      }

      #output {
        background: rgba(15, 17, 20, 0.85); /* 深いグレーブラック。宇宙ネイビーにも調和 */
        backdrop-filter: blur(12px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 16px;
        color: #e5e5e7;
        font-family: "SF Mono", "Menlo", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-y: auto;
        height: 300px;
        transition: background 0.3s ease, border 0.3s ease;
      }

      #output span {
        color: #d1d1d6; /* 標準出力: ソフトグレー */
      }

      /* スクロールバー（macOSっぽく） */
      #output::-webkit-scrollbar {
        width: 8px;
      }

      #output::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      #output::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }


    </style>

  </head>


  <body>

    <!-- Layout -->
    <div class="app">
      <div class="left">
        <div class="card">
          <div class="header">
            <div class="logo">CL</div>
            <div>
              <div class="title">Cairns Lab</div>
              <div class="subtitle">served by cairnsberry@192.168.11.11</div>
            </div>
          </div>
          <div class="group-title">Quick Actions</div>
          <div class="group-title">I2C Devices Control</div>
            <!-- Buttons related to I2C devices -->
            <button class="button" onclick="detectI2C()">Detect I2C Devices</button>
          <div class="group-title">Joy-Con Control</div>
            <!-- Buttons related to bluetooth control -->
            <button class="button" onclick="ConnJoyCon()"> Register JoyCon</button>
            <button class="button" onclick="getPaired()"> Paired Devices</button>
            <ul id="paired-list"></ul>
        </div>
        <!-- Output Console -->
        <div>
          <div style="font-weight:600">Console</div>
          <pre id="output">(Console will appear here...)</pre>
        </div>
      </div>

      <!-- Blockly workspace -->
      <div class="right">
        <div>
          <button class="button" onclick="loadBlock()">Open Block</button>
          <button class="button" onclick="saveBlock()">Save As</button>
          <button class="button" onclick="sendCode()">Run</button>
          <button class="button" onclick="terminateCode()">Terminate</button>
          <button class="button" onclick="showCode()">Show Code</button>
          <!-- Buttons to show/run/terminate programm coded by Blockly -->
          <!-- button class="button" onclick="showCode()">Show Python Code</button>
          <button class="button" onclick="sendCode()">Run on Rpi</button>
          <button class="button" onclick="terminateCode()">Terminate</button-->
          <!-- CAUSION: use following "run_python()" for test or debug only -->
          <!--button onclick="run_python()">Run on Rpi test mode</button-->
        </div>
        <div id="blocklyDiv"></div>
      </div>
    </div>






    <script>
      // inject toolbox to Blockly Workspace
      var demoWorkspace = Blockly.inject('blocklyDiv', {
        toolbox: toolbox,
      });

      // inject start blocks to the Blocky Workspace
      Blockly.serialization.workspaces.load(startBlocks, demoWorkspace);

      // setup socket io to show raspberry pi stdout on the Output Console real time  
      const socket = io();

      function showCode() {
        // Generate Python code based on Block in the Workspace and display it.
      	python.pythonGenerator.INFINITE_LOOP_TRAP = null;
	      var code =
	      python.pythonGenerator.workspaceToCode(demoWorkspace);
        alert(code);
      }

      // CAUSION: use "sendCode()" instead of this function
      function run_python() {
        // run "code" on RPi, the "code" output is handed from RPi to client after "code" implementred
        python.pythonGenerator.INFINITE_LOOP_TRAP = null;
        var code = python.pythonGenerator.workspaceToCode(demoWorkspace);
        console.log(code);
        fetch(`/jsonrpi`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(code)
        })
        .then(response => response.text())
        .then(data => console.log(data))
      }

      // Generate python code, then make RPi server run "run_code" with socket io
      function sendCode() {
        python.pythonGenerator.INFINITE_LOOP_TRAP = null;
		    var code = python.pythonGenerator.workspaceToCode(demoWorkspace);
		    socket.emit('run_code', code);
      }

      // If server gives back "output" event, then log it to console 
      socket.on("output", (data) => {
        console.log(data);
      });

      // If server goves back "output" event, then log it to Output Console
    	socket.on("output", (data) => {
		    const outputElem = document.getElementById("output");
    		outputElem.textContent += data.message + "\n";
    		outputElem.scrollTop = outputElem.scrollHeight;  // auto-scroll
  	  });

      // make RPi server run "stop_code"
    	function terminateCode() {
    		socket.emit("stop_code");
	    }

      // save block in the current Blockly Worlspace to client PC local
      // CAUSION: "showSaveFilePicker" works on Edge, Chrome, Opera. Not work at Firefox, Safari.
      async function saveBlock(){
        const opts = {
          suggestedName: 'example',
          types: [{
            description: 'Text file',
            accept: {'text/plain': ['.txt']},
          }],
        };
        const data = Blockly.serialization.workspaces.save(demoWorkspace);
        console.log(JSON.stringify(data))
        const handle = await window.showSaveFilePicker(opts);
        const writable = await handle.createWritable()
        await writable.write(JSON.stringify(data))
        await writable.close()
      }

      // load block to the current Blockly Worlspace from client PC local
      // CAUSION: "showSaveFilePicker" works on Edge, Chrome, Opera. Not work at Firefox, Safari.
      async function loadBlock(){
        const [handle] = await window.showOpenFilePicker({
          types: [{
            description: 'Text file',
            accept: {
              'text/plain*': [
                '.txt'
              ]
            }
          }]
        })
        const file = await handle.getFile();
        const text = await file.text();
        console.log(text)
        Blockly.Events.disable();
        Blockly.serialization.workspaces.load(JSON.parse(text), demoWorkspace);
        Blockly.Events.enable();
      }

      // ### Followings are code related to bluetooth control ###
      // To Do: Remove "接続" from "getPaired" because this often doesn't work, maybe due to RPi
      // To Do: Paired device must be "removed" when RPi shutdown or keep device disconnect long term.
      //        This is because "ConnJoyCon" doesn't detect the device which has already registered.
      // To Do: Put progress or current status on the Output Console.

      // scan and connect to JoyCon
      async function ConnJoyCon() {
        alert('make Joy-Con stand-by mode');
        const outputElem = document.getElementById("output");
        outputElem.textContent += "\n" + "scannning Joy-Con... ";
        const res = await fetch("/scan-connect", {
          method: "POST",
          headers: { "Content-Type": "application/json"},
        });
        const result = await res.json();
        console.log(result.result || result.error);
        outputElem.textContent += result.result || result.error;
        outputElem.scrollTop = outputElem.scrollHeight;
      }

      // Show paired device list and command
      async function getPaired() {
        const res = await fetch("/paired");
        const devices = await res.json();
        const list = document.getElementById("paired-list");
        list.innerHTML = "";
        devices.forEach(device => {
        const item = document.createElement("li");
        item.textContent = `${device.name} [${device.mac}] `;
        const connectBtn = document.createElement("button");
        connectBtn.textContent = "Connect";
        connectBtn.onclick = () => connect(device.mac);
        item.appendChild(connectBtn);
        const disconnectBtn = document.createElement("button");
        disconnectBtn.textContent = "Disconnect";
        disconnectBtn.onclick = () => disconnect(device.mac);
        item.appendChild(disconnectBtn);
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.onclick = () => remove(device.mac);
        item.appendChild(removeBtn);
        list.appendChild(item);
        });
      }

      async function connect(mac) {
	      alert('make device stand-by mode');
        const outputElem = document.getElementById("output");
        outputElem.textContent += "\n" + "scanning Joy-Con... ";
        const res = await fetch("/connect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mac: mac })
        });
        const result = await res.json();
        console.log(result.result || result.error);
        outputElem.textContent += result.result || result.error;
        outputElem.scrollTop = outputElem.scrollHeight;
      }

      async function disconnect(mac) {
        const res = await fetch("/disconnect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mac: mac })
        });
        const result = await res.json();
        console.log(result.result || result.error);
        const outputElem = document.getElementById("output");
        outputElem.textContent += result.result || result.error;
        outputElem.scrollTop = outputElem.scrollHeight;
      }

      async function remove(mac) {
        const res = await fetch("/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mac: mac })
        });
        const result = await res.json();
        console.log(result.result || result.error);
        const outputElem = document.getElementById("output");
        outputElem.textContent += result.result || result.error;
        outputElem.scrollTop = outputElem.scrollHeight;
        getPaired(); // list update
      }

      async function detectI2C() {
        const outputElem = document.getElementById("output");
        const res = await fetch("/detect_i2c", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
        });
        const result = await res.json();
        console.log(result.result || result.error);
        outputElem.textContent += result.result || result.error;
        outputElem.scrollTop = outputElem.scrollHeight;
      }

    </script>
  </body>
</html>
